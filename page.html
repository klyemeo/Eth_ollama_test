<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 AI Vision (Ollama)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 700px; margin: 2rem auto; padding: 0 1rem; background-color: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        
        #chat-box { 
            border: 1px solid #ddd; 
            height: 400px; 
            overflow-y: scroll; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 10px; 
            background: white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; max-width: 80%; }
        .user-msg { background-color: #e3f2fd; margin-left: auto; text-align: right; color: #0d47a1; }
        .ai-msg { background-color: #f1f8e9; margin-right: auto; text-align: left; color: #2e7d32; }
        
        .preview-img { max-width: 200px; border-radius: 5px; margin-top: 5px; display: block; margin-left: auto; }
        
        .controls { display: flex; gap: 10px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ */
        .file-upload { position: relative; overflow: hidden; display: inline-block; }
        .file-upload input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .btn-upload { background-color: #6c757d; }
        #fileName { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: right; display: block;}
    </style>
</head>
<body>

    <h1>üëÅÔ∏è ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI (‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ)</h1>
    
    <div id="chat-box"></div>
    
    <div id="fileName"></div>
    <div class="controls">
        <div class="file-upload">
            <button class="btn-upload">üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
            <input type="file" id="imageInput" accept="image/*" onchange="showFileName()">
        </div>
        <input type="text" id="userInput" placeholder="‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ..." onkeydown="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">‡∏™‡πà‡∏á</button>
    </div>

    <script>
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô Base64 (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å)
        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showFileName() {
            const fileInput = document.getElementById('imageInput');
            const fileNameDisplay = document.getElementById('fileName');
            if(fileInput.files.length > 0) {
                fileNameDisplay.textContent = "‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = "";
            }
        }

        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const imageInput = document.getElementById("imageInput");
            const chatBox = document.getElementById("chat-box");
            
            const text = inputField.value;
            const file = imageInput.files[0];

            if (!text && !file) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏™‡πà‡∏á

            let base64Image = null;
            let displayImageHtml = "";

            // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (file) {
                try {
                    const fullBase64 = await convertToBase64(file);
                    // Ollama ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡πà‡πÑ‡∏™‡πâ‡πÉ‡∏ô (‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ data:image/jpeg;base64, ‡∏≠‡∏≠‡∏Å)
                    base64Image = fullBase64.split(',')[1]; 
                    displayImageHtml = `<img src="${fullBase64}" class="preview-img">`;
                } catch (e) {
                    console.error("‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô", e);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ");
                    return;
                }
            }

            // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ (User)
            chatBox.innerHTML += `
                <div class="message user-msg">
                    ${text}
                    ${displayImageHtml}
                </div>`;
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ input
            inputField.value = "";
            imageInput.value = ""; 
            document.getElementById('fileName').textContent = "";
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î
            const loadingId = "loading-" + Date.now();
            chatBox.innerHTML += `<div class="message ai-msg" id="${loadingId}"><i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</i></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á AI
                const payload = {
                    model: "llama3.2-vision",  // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ
                    messages: [{
                        role: "user",
                        content: text || "Describe this image", // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡πÅ‡∏ó‡∏ô‡∏ß‡πà‡∏≤ "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ"
                        images: base64Image ? [base64Image] : [] // ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    }],
                    stream: false
                };

                // 3. ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏´‡∏≤ Ollama
                const response = await fetch("http://localhost:11434/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö AI
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="message ai-msg"><b>AI:</b> ${data.message.content}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch (error) {
                document.getElementById(loadingId).innerHTML = `<span style="color:red">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ CORS ‡∏´‡∏£‡∏∑‡∏≠ Ollama ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°)</span>`;
                console.error(error);
            }
        }
    </script>

</body>
</html>